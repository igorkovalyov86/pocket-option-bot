<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Торговый Трекер</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Все стили остаются без изменений */
        /* ... */
    </style>
</head>
<body>
    <!-- Весь HTML остаётся без изменений -->
    <!-- ... -->
    
    <script>
        // Global variables
        let completedDaysArray = new Array(365).fill(false);
        let currentDayIndex = 1;
        
        // Base percentages for Ultra mode (6 and 7 steps)
        const ultraPercentages = {
            6: [1, 1.5, 3.5, 8, 20, 60],
            7: [1, 1.5, 3.5, 8, 20, 60, 150]
        };
        
        const quotes = [
            {text: "Рискуйте только тем капиталом, который вы готовы потерять.", author: "Уоррен Баффет"},
            {text: "Рынки могут оставаться иррациональными дольше, чем вы можете оставаться платежеспособными.", author: "Джон Мейнард Кейнс"},
            {text: "Покупай, когда на улицах кровь.", author: "Барон Ротшильд"},
            {text: "Время на вашей стороне, когда вы владеете акциями.", author: "Питер Линч"},
            {text: "Цена - это то, что вы платите. Ценность - это то, что вы получаете.", author: "Уоррен Баффет"},
            {text: "Дисциплина важнее мотивации. Последовательность действий приводит к выдающимся результатам.", author: "Джеймс Клир"}
        ];
        
        // Format numbers with separators
        function formatNumber(num, isInteger = false) {
            if (num === null || num === undefined) return '';
            
            if (isInteger) {
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            } else {
                return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }
        }
        
        // Save data to localStorage
        function saveData() {
            const data = {
                steps: document.getElementById('steps').value,
                ultraSteps: document.getElementById('ultraSteps').value,
                startBalance: document.getElementById('startBalance').value,
                ultraStartBalance: document.getElementById('ultraStartBalance').value,
                firstTradePercent: document.getElementById('firstTradePercent').value,
                ultraFirstTradePercent: document.getElementById('ultraFirstTradePercent').value,
                martingaleCoefficient: document.getElementById('martingaleCoefficient').value,
                assetProfitability: document.getElementById('assetProfitability').value,
                ultraAssetProfitability: document.getElementById('ultraAssetProfitability').value,
                initialDeposit: document.getElementById('initialDeposit').value,
                dailyGrowth: document.getElementById('dailyGrowth').value,
                startDate: document.getElementById('startDate').value,
                currentDate: document.getElementById('currentDate').value,
                completedDays: completedDaysArray,
                ultraMode: document.getElementById('ultraMode').checked
            };
            localStorage.setItem('tradingTrackerData', JSON.stringify(data));
        }
        
        // Load data from localStorage
        function loadData() {
            const data = JSON.parse(localStorage.getItem('tradingTrackerData'));
            
            // Всегда устанавливаем текущую дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            
            if (data) {
                document.getElementById('steps').value = data.steps || 8;
                document.getElementById('ultraSteps').value = data.ultraSteps || '6';
                document.getElementById('startBalance').value = data.startBalance || 100;
                document.getElementById('ultraStartBalance').value = data.ultraStartBalance || 100;
                document.getElementById('firstTradePercent').value = data.firstTradePercent || 1;
                document.getElementById('ultraFirstTradePercent').value = data.ultraFirstTradePercent || 1;
                document.getElementById('martingaleCoefficient').value = data.martingaleCoefficient || 2.2;
                document.getElementById('assetProfitability').value = data.assetProfitability || 92;
                document.getElementById('ultraAssetProfitability').value = data.ultraAssetProfitability || 92;
                document.getElementById('initialDeposit').value = data.initialDeposit || 1000;
                document.getElementById('dailyGrowth').value = data.dailyGrowth || 1.5;
                document.getElementById('startDate').value = data.startDate || "2025-06-01";
                
                // Устанавливаем текущую дату, даже если в сохраненных данных есть другая
                document.getElementById('currentDate').value = today;
                
                completedDaysArray = data.completedDays || new Array(365).fill(false);
                
                if (data.ultraMode) {
                    document.getElementById('ultraMode').checked = true;
                }
            } else {
                document.getElementById('startDate').value = "2025-06-01";
                document.getElementById('currentDate').value = today;
                completedDaysArray = new Array(365).fill(false);
            }
        }
        
        // Create background particles
        function createParticles() {
            const container = document.getElementById('particles');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                const size = Math.random() * 8 + 2;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100 + 100;
                const delay = Math.random() * 15;
                const duration = 15 + Math.random() * 15;
                const color = `rgba(${Math.floor(Math.random() * 100 + 155)}, 
                                 ${Math.floor(Math.random() * 100 + 155)}, 
                                 ${Math.floor(Math.random() * 200 + 55)}, 
                                 ${Math.random() * 0.4 + 0.1})`;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}%`;
                particle.style.top = `${posY}%`;
                particle.style.background = color;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                container.appendChild(particle);
            }
        }
        
        // Calculate required amount for all steps
        function calculateRequiredAmount() {
            const ultraMode = document.getElementById('ultraMode').checked;
            
            if (ultraMode) {
                const ultraSteps = parseInt(document.getElementById('ultraSteps').value);
                const startBalance = parseFloat(document.getElementById('ultraStartBalance').value) || 0;
                const firstTradePercent = parseFloat(document.getElementById('ultraFirstTradePercent').value) || 1;
                
                const basePercentages = ultraPercentages[ultraSteps];
                const ultraPercents = basePercentages.map(p => p * (firstTradePercent / 1));
                const totalPercent = ultraPercents.reduce((sum, p) => sum + p, 0);
                const requiredAmount = startBalance * totalPercent / 100;
                
                return requiredAmount;
            } else {
                const steps = parseInt(document.getElementById('steps').value);
                const startBalance = parseFloat(document.getElementById('startBalance').value) || 0;
                const firstTradePercent = parseFloat(document.getElementById('firstTradePercent').value) || 1;
                const martingaleCoefficient = parseFloat(document.getElementById('martingaleCoefficient').value) || 2.2;
                
                let requiredAmount = 0;
                let currentTrade = startBalance * (firstTradePercent / 100);
                
                for (let i = 1; i <= steps; i++) {
                    requiredAmount += currentTrade;
                    currentTrade *= martingaleCoefficient;
                }
                
                return requiredAmount;
            }
        }
        
        // Update balance warnings
        function updateBalanceWarnings() {
            const ultraMode = document.getElementById('ultraMode').checked;
            const requiredAmount = calculateRequiredAmount();
            
            if (ultraMode) {
                const startBalance = parseFloat(document.getElementById('ultraStartBalance').value) || 0;
                const warningElement = document.getElementById('ultraWarning');
                const amountElement = document.getElementById('ultraRequiredAmount');
                
                if (requiredAmount > startBalance) {
                    const additional = requiredAmount - startBalance;
                    amountElement.textContent = '$' + formatNumber(additional);
                    warningElement.style.display = 'block';
                } else {
                    warningElement.style.display = 'none';
                }
                
                document.getElementById('standardWarning').style.display = 'none';
            } else {
                const startBalance = parseFloat(document.getElementById('startBalance').value) || 0;
                const warningElement = document.getElementById('standardWarning');
                const amountElement = document.getElementById('standardRequiredAmount');
                
                if (requiredAmount > startBalance) {
                    const additional = requiredAmount - startBalance;
                    amountElement.textContent = '$' + formatNumber(additional);
                    warningElement.style.display = 'block';
                } else {
                    warningElement.style.display = 'none';
                }
                
                document.getElementById('ultraWarning').style.display = 'none';
            }
        }
        
        // Calculate balance distribution table
        function calculateStepsTable() {
            const ultraMode = document.getElementById('ultraMode').checked;
            
            let tableHTML = '';
            
            if (ultraMode) {
                // Ultra mode: steps with proportional percentages
                const ultraSteps = parseInt(document.getElementById('ultraSteps').value);
                const startBalance = parseFloat(document.getElementById('ultraStartBalance').value);
                const firstTradePercent = parseFloat(document.getElementById('ultraFirstTradePercent').value);
                const assetProfitability = parseFloat(document.getElementById('ultraAssetProfitability').value) / 100;
                
                // Get base percentages for selected steps
                const basePercentages = ultraPercentages[ultraSteps];
                
                // Calculate percentages based on first trade percent
                const ultraPercents = basePercentages.map(p => p * (firstTradePercent / 1));
                
                let totalPreviousTrades = 0;
                let cumulativeAmount = 0;
                
                for (let i = 0; i < ultraPercents.length; i++) {
                    const percent = ultraPercents[i];
                    const currentTrade = startBalance * (percent / 100);
                    cumulativeAmount += currentTrade;
                    
                    const netProfit = (currentTrade * assetProfitability) - totalPreviousTrades;
                    totalPreviousTrades += currentTrade;
                    
                    const cumulativePercent = (cumulativeAmount / startBalance) * 100;
                    
                    tableHTML += `
                        <tr>
                            <td>${i+1}</td>
                            <td>
                                $${formatNumber(currentTrade, false)}
                                <span class="ultra-amount-percent"> (${percent.toFixed(2)}%)</span>
                            </td>
                            <td>$${formatNumber(cumulativeAmount, false)} (${cumulativePercent.toFixed(2)}%)</td>
                            <td>$${formatNumber(netProfit, false)}</td>
                        </tr>
                    `;
                }
            } else {
                // Regular mode
                const steps = parseInt(document.getElementById('steps').value);
                const startBalance = parseFloat(document.getElementById('startBalance').value);
                const firstTradePercent = parseFloat(document.getElementById('firstTradePercent').value) / 100;
                const martingaleCoefficient = parseFloat(document.getElementById('martingaleCoefficient').value);
                const assetProfitability = parseFloat(document.getElementById('assetProfitability').value) / 100;
                
                let totalPreviousTrades = 0;
                let currentTrade = startBalance * firstTradePercent;
                let cumulativeAmount = 0;
                
                for (let i = 1; i <= steps; i++) {
                    cumulativeAmount += currentTrade;
                    
                    const netProfit = (currentTrade * assetProfitability) - totalPreviousTrades;
                    totalPreviousTrades += currentTrade;
                    
                    const cumulativePercent = (cumulativeAmount / startBalance) * 100;
                    
                    tableHTML += `
                        <tr>
                            <td>${i}</td>
                            <td>$${formatNumber(currentTrade, false)}</td>
                            <td>$${formatNumber(cumulativeAmount, false)} (${cumulativePercent.toFixed(2)}%)</td>
                            <td>$${formatNumber(netProfit, false)}</td>
                        </tr>
                    `;
                    
                    currentTrade *= martingaleCoefficient;
                }
            }
            
            document.querySelector('#stepsTable tbody').innerHTML = tableHTML;
            saveData();
            updateBalanceWarnings();
        }
        
        // Toggle Ultra mode
        function toggleUltraMode() {
            const ultraMode = document.getElementById('ultraMode').checked;
            const ultraLabel = document.getElementById('ultraLabel');
            const ultraControls = document.getElementById('ultraControls');
            const standardControls = document.getElementById('standardControls');
            const cumulativeColumn = document.getElementById('cumulativeColumn');
            const amountColumn = document.getElementById('amountColumn');
            
            if (ultraMode) {
                ultraLabel.innerHTML = 'РЕЖИМ <span style="color:#ff9a9e">ULTRA</span> АКТИВИРОВАН';
                
                // Show ultra controls, hide standard controls
                ultraControls.style.display = 'flex';
                standardControls.style.display = 'none';
                
                // Show cumulative column
                cumulativeColumn.style.display = '';
                
                // Change column header
                amountColumn.innerHTML = 'Сумма<span class="ultra-header-percent"> (% от депозита)</span>';
            } else {
                ultraLabel.textContent = 'Режим ULTRA';
                
                // Show standard controls, hide ultra controls
                standardControls.style.display = 'flex';
                ultraControls.style.display = 'none';
                
                // Show cumulative column
                cumulativeColumn.style.display = '';
                
                // Reset column header
                amountColumn.textContent = 'Сумма';
            }
            
            // Recalculate table
            calculateStepsTable();
        }
        
        // Calculate compound interest
        function calculateCompoundInterest() {
            const initialDeposit = parseFloat(document.getElementById('initialDeposit').value) || 1000;
            const dailyGrowth = parseFloat(document.getElementById('dailyGrowth').value) || 1.5;
            const growthRate = dailyGrowth / 100;
            
            const compoundDays = [30, 60, 100, 200, 300, 365];
            let tableHTML = '';
            
            for (let i = 0; i < compoundDays.length; i++) {
                const day = compoundDays[i];
                const balance = initialDeposit * Math.pow(1 + growthRate, day);
                
                tableHTML += `
                    <tr>
                        <td>${day}</td>
                        <td>$${formatNumber(balance, true)}</td>
                    </tr>
                `;
            }
            
            document.getElementById('compoundTableBody').innerHTML = tableHTML;
            saveData();
        }
        
        // Scroll to current day in progress table
        function scrollToCurrentDay() {
            setTimeout(() => {
                const currentDayRow = document.querySelector('.current-day');
                if (currentDayRow) {
                    const container = document.querySelector('.progress-container-365');
                    const rowTop = currentDayRow.offsetTop;
                    const rowHeight = currentDayRow.offsetHeight;
                    const scrollPosition = rowTop - (container.clientHeight / 2) + (rowHeight / 2);
                    
                    container.scrollTo({
                        top: scrollPosition,
                        behavior: 'smooth'
                    });
                }
            }, 300);
        }
        
        // Calculate progress table
        function calculateProgressTable() {
            const startDate = new Date(document.getElementById('startDate').value);
            const currentDate = new Date(document.getElementById('currentDate').value);
            const initialDeposit = parseFloat(document.getElementById('initialDeposit').value) || 1000;
            const dailyGrowth = parseFloat(document.getElementById('dailyGrowth').value) || 1.5;
            const growthRate = dailyGrowth / 100;
            
            const diffTime = Math.abs(currentDate - startDate);
            currentDayIndex = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            let tableHTML = '';
            let actualBalance = initialDeposit;
            
            for (let day = 1; day <= 365; day++) {
                const isToday = day === currentDayIndex;
                const isFuture = day > currentDayIndex;
                
                const plannedBalance = initialDeposit * Math.pow(1 + growthRate, day - 1);
                const dailyPlan = plannedBalance * growthRate;
                
                if (day <= currentDayIndex && completedDaysArray[day-1]) {
                    actualBalance = actualBalance * (1 + growthRate);
                }
                
                tableHTML += `
                    <tr ${isToday ? 'class="current-day"' : ''}>
                        <td>${day}</td>
                        <td>$${formatNumber(plannedBalance, false)}</td>
                        <td>${isFuture ? '-' : '$' + formatNumber(actualBalance, false)}</td>
                        <td>${completedDaysArray[day-1] ? '$' + formatNumber(dailyPlan, false) : '-'}</td>
                        <td>
                            <div class="checkbox ${completedDaysArray[day-1] ? 'checked' : ''}" 
                                 data-day="${day}"></div>
                        </td>
                    </tr>
                `;
            }
            
            document.getElementById('progressTableBody').innerHTML = tableHTML;
            
            const completedCount = completedDaysArray.filter(v => v).length;
            document.getElementById('completedDays').textContent = completedCount;
            document.getElementById('currentBalance').textContent = '$' + formatNumber(actualBalance, false);
            document.getElementById('todayPlan').textContent = '$' + formatNumber(actualBalance * growthRate, false);
            
            const plannedBalanceToday = initialDeposit * Math.pow(1 + growthRate, currentDayIndex - 1);
            const deviation = actualBalance - plannedBalanceToday;
            
            document.getElementById('plannedBalance').textContent = '$' + formatNumber(plannedBalanceToday, false);
            document.getElementById('actualBalance').textContent = '$' + formatNumber(actualBalance, false);
            document.getElementById('deviation').textContent = deviation >= 0 ? 
                '+$' + formatNumber(Math.abs(deviation), false) : '-$' + formatNumber(Math.abs(deviation), false);
            
            setupCheckboxes();
            scrollToCurrentDay();
            saveData();
        }
        
        // Recalculate balances without rebuilding the entire table
        function recalculateBalances() {
            const initialDeposit = parseFloat(document.getElementById('initialDeposit').value) || 1000;
            const dailyGrowth = parseFloat(document.getElementById('dailyGrowth').value) || 1.5;
            const growthRate = dailyGrowth / 100;
            
            let actualBalance = initialDeposit;
            
            const rows = document.querySelectorAll('#progressTableBody tr');
            rows.forEach((row, index) => {
                const day = index + 1;
                const plannedBalance = initialDeposit * Math.pow(1 + growthRate, day - 1);
                const dailyPlan = plannedBalance * growthRate;
                
                if (completedDaysArray[index]) {
                    actualBalance = actualBalance * (1 + growthRate);
                }
                
                row.cells[1].textContent = '$' + formatNumber(plannedBalance, false);
                row.cells[2].textContent = day > currentDayIndex ? '-' : '$' + formatNumber(actualBalance, false);
                row.cells[3].textContent = completedDaysArray[index] ? '$' + formatNumber(dailyPlan, false) : '-';
            });
            
            document.getElementById('currentBalance').textContent = '$' + formatNumber(actualBalance, false);
            document.getElementById('todayPlan').textContent = '$' + formatNumber(actualBalance * growthRate, false);
            
            const plannedBalanceToday = initialDeposit * Math.pow(1 + growthRate, currentDayIndex - 1);
            const deviation = actualBalance - plannedBalanceToday;
            
            document.getElementById('plannedBalance').textContent = '$' + formatNumber(plannedBalanceToday, false);
            document.getElementById('actualBalance').textContent = '$' + formatNumber(actualBalance, false);
            document.getElementById('deviation').textContent = deviation >= 0 ? 
                '+$' + formatNumber(Math.abs(deviation), false) : '-$' + formatNumber(Math.abs(deviation), false);
            
            saveData();
        }
        
        // Setup checkbox event handlers
        function setupCheckboxes() {
            const checkboxes = document.querySelectorAll('#progressTableBody .checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    const day = parseInt(this.getAttribute('data-day'));
                    
                    if (this.classList.contains('checked')) {
                        this.classList.remove('checked');
                        completedDaysArray[day-1] = false;
                    } else {
                        this.classList.add('checked');
                        completedDaysArray[day-1] = true;
                    }
                    
                    const completedCount = completedDaysArray.filter(v => v).length;
                    document.getElementById('completedDays').textContent = completedCount;
                    
                    recalculateBalances();
                });
            });
        }
        
        // Update daily quote
        function updateDailyQuote() {
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('dailyQuote').innerHTML = 
                `"${quote.text}"<span class="author">— ${quote.author}</span>`;
        }
        
        // Reset progress
        function resetProgress() {
            if (confirm("Вы уверены, что хотите сбросить весь прогресс? Это действие нельзя отменить.")) {
                completedDaysArray = new Array(365).fill(false);
                document.getElementById('startDate').value = "2025-06-01";
                document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
                calculateProgressTable();
                alert("Прогресс успешно сброшен!");
            }
        }
        
        // Update step attribute for inputs
        function updateStep(input) {
            let value = parseFloat(input.value);
            if (isNaN(value)) {
                value = input.id === 'martingaleCoefficient' ? 2.2 : 
                        input.id === 'dailyGrowth' ? 1.5 : 
                        input.id.includes('Profitability') ? 92 : 1;
                input.value = value;
            }
            
            // Для коэффициента мартингейла: если >=0.1, шаг 0.1, иначе 0.01
            if (input.id === 'martingaleCoefficient') {
                if (value >= 0.1) {
                    input.step = "0.1";
                } else {
                    input.step = "0.01";
                }
            }
            // Для доходности по активу: если >=1, шаг = 1, иначе шаг = 0.1
            else if (input.id.includes('Profitability')) {
                if (value >= 1) {
                    input.step = "1";
                } else {
                    input.step = "0.1";
                }
            }
            // Для % прироста в сложном проценте: если >=0.1, шаг 0.1, иначе 0.01
            else if (input.id === 'dailyGrowth') {
                if (value >= 0.1) {
                    input.step = "0.1";
                } else {
                    input.step = "0.01";
                }
            }
            // Для процентных полей (в остальных случаях)
            else if (input.id.includes('Percent')) {
                if (value >= 0.1) {
                    input.step = "0.1";
                } else {
                    input.step = "0.01";
                }
            }
        }
        
        // Validate non-negative numbers
        function validateNonNegative(input) {
            if (parseFloat(input.value) < 0) {
                input.value = 0;
            }
        }
        
        // Initialize on page load
        window.onload = function() {
            createParticles();
            updateDailyQuote();
            
            // Load data from localStorage
            loadData();
            
            // Initialize data
            calculateStepsTable();
            calculateCompoundInterest();
            calculateProgressTable();
            
            // Event handlers
            document.getElementById('steps').addEventListener('change', calculateStepsTable);
            document.getElementById('ultraSteps').addEventListener('change', calculateStepsTable);
            document.getElementById('startBalance').addEventListener('input', calculateStepsTable);
            document.getElementById('ultraStartBalance').addEventListener('input', calculateStepsTable);
            document.getElementById('firstTradePercent').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateStepsTable();
            });
            document.getElementById('ultraFirstTradePercent').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateStepsTable();
            });
            document.getElementById('martingaleCoefficient').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateStepsTable();
            });
            document.getElementById('assetProfitability').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateStepsTable();
            });
            document.getElementById('ultraAssetProfitability').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateStepsTable();
            });
            
            document.getElementById('initialDeposit').addEventListener('input', function() {
                validateNonNegative(this);
                calculateCompoundInterest();
                recalculateBalances();
            });
            
            document.getElementById('dailyGrowth').addEventListener('input', function() {
                validateNonNegative(this);
                updateStep(this);
                calculateCompoundInterest();
                recalculateBalances();
            });
            
            document.getElementById('startDate').addEventListener('change', calculateProgressTable);
            document.getElementById('currentDate').addEventListener('change', calculateProgressTable);
            
            document.getElementById('resetProgress').addEventListener('click', resetProgress);
            
            document.getElementById('ultraMode').addEventListener('change', toggleUltraMode);
            toggleUltraMode();
            
            // Initialize step for inputs
            updateStep(document.getElementById('firstTradePercent'));
            updateStep(document.getElementById('ultraFirstTradePercent'));
            updateStep(document.getElementById('martingaleCoefficient'));
            updateStep(document.getElementById('assetProfitability'));
            updateStep(document.getElementById('ultraAssetProfitability'));
            updateStep(document.getElementById('dailyGrowth'));
            
            // Add validation to all number inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function() {
                    validateNonNegative(this);
                });
            });
        };
    </script>
</body>
</html>